import { GoogleGenerativeAI } from "@google/generative-ai";

// Configuración de API
const API_KEY = (import.meta as any).env.VITE_GEMINI_API_KEY || "";
const genAI = new GoogleGenerativeAI(API_KEY);

// 1. COSTES DE CRÉDITOS (Sincronizados con todas tus páginas)
export const AI_CREDIT_COSTS = {
    chatMessage: 1,
    generateProposal: 2,
    enhanceTimeEntry: 1,
    analyzeProfitability: 3,
    rankArticles: 1
};

const SYSTEM_INSTRUCTION =
`Eres el "Estratega Principal de DevFreelancer", un consultor experto con más de 15 años de trayectoria en desarrollo de software, gestión de agencias y optimización de flujos de caja para freelancers.

REGLAS DE ORO DE RESPUESTA:
1. PERSONALIDAD: Actúa como un mentor Senior. Sé analítico, directo y obsesionado con el valor de negocio.
2. FORMATO PROFESIONAL: Usa ## para títulos, **negritas** para términos clave y tablas Markdown.
3. ENFOQUE EN VALOR: Cada respuesta debe concluir con "> **Consejo Estratégico Pro:**".
4. CONTEXTO: Ayudas en la gestión de clientes, proyectos, facturas y gastos dentro de DevFreelancer.app.`;

export const getAIResponse = async (prompt: string, history: any[] = []) => {
  const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
  const chat = model.startChat({
    history: history.map(msg => ({
      role: msg.role === 'ai' ? 'model' : 'user',
      parts: [{ text: msg.text || "" }]
    })),
  });
  const result = await chat.sendMessage(prompt);
  return result.response;
};

// 2. Análisis Financiero
export const analyzeProfitability = async (data: any) => {
  const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
  const result = await model.generateContent(`Analiza: ${JSON.stringify(data)}`);
  return result.response.text();
};

// 3. Propuestas
export const generateProposalText = async (title: string, context: string, profile: string) => {
  const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
  const result = await model.generateContent(`Propuesta para ${title}. Contexto: ${context}. Perfil: ${profile}`);
  return result.response.text();
};

// 4. Descripciones de tiempo
export const generateTimeEntryDescription = async (task: string, notes: string) => {
  const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
  const result = await model.generateContent(`Resume en una frase: ${task}, ${notes}`);
  return result.response.text().trim();
};

/**
 * Clasifica artículos por relevancia usando IA para la base de conocimientos
 */
export const rankArticlesByRelevance = async (query: string, articles: any[]): Promise<string[]> => {
  try {
    const model = genAI.getGenerativeModel({ 
        model: "gemini-1.5-flash",
        systemInstruction: "Eres un experto en organización de información y búsqueda semántica."
    });

    const articlesContext = articles.map(a => `ID: ${a.id}, Título: ${a.title}`).join('\n');
    
    const prompt = `
      Dada la siguiente consulta del usuario: "${query}"
      Y esta lista de artículos:
      ${articlesContext}
      
      Devuelve ÚNICAMENTE una lista de los IDs de los artículos que sean relevantes, ordenados del más al menos relevante, separados por comas. Si ninguno es relevante, devuelve una cadena vacía.
    `;

    const result = await model.generateContent(prompt);
    const response = await result.response;
    const text = response.text().trim();
    
    // Convertimos la respuesta de la IA (IDs separados por coma) en un array
    return text ? text.split(',').map(id => id.trim()) : [];
  } catch (error) {
    console.error("Error en rankArticlesByRelevance:", error);
    return []; // Fallback: no filtramos nada si falla
  }
};